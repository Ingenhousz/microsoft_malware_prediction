# TODO do stacking!!
from util import *


# %% read in data
def main(debug=True):

    with timer("read in files"):
        if debug:
            train, test = read_files(debug)
        else:
            train, test = read_pickle()
        print(train.shape)

    with timer("add time stamp"):
        train, test = add_timestamp(train, test)
        print(train.shape)

    with timer("initial feature engineering"):
        train, test = initial_engineering(train, test)
        print(train.shape)

    with timer("drop useless features"):
        train, test = drop_useless(train, test)
        print(train.shape)

    with timer('convert data to sparse matrix'):  # improve to 0.661
        y_train, train_ids, test_ids, train, test = transfer_sparse(train, test)
        print(train.shape)

    with timer('target encoding'):
        for col in train.columns:
            train[col+'t'], test[col+'t'] = target_encode(train[col], test[col], y_train)
        print(train.shape)

    with timer('one hot encoding'):
        train, test, m = one_hot(train, test)
        print(train.shape)

    with timer('build model'):
        lgb_train_result, lgb_test_result, score = k_fold_lgbm(train, test, y_train, train_ids, test_ids, m, debug)

    with timer('generate submission files'):
        print('lgbm:', score)
        if not debug:
            lgb_train_result.to_pickle('output/lgb_train_result.pkl')
            lgb_test_result.to_pickle('output/lgb_test_result.pkl')
            save_submission(lgb_test_result, score, 'lgbm')


if __name__ == '__main__':
    main(debug=False)
